<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neurosynth API Explorer</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }
    .result-card {
      transition: all 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
  
  <!-- Header -->
  <header class="glass border-b border-gray-200">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
          <i class="fas fa-brain text-indigo-600"></i>
          Neurosynth API Explorer
        </h1>
        <a href="https://mil.psy.ntu.edu.tw:5000" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-2">
          <i class="fas fa-external-link-alt"></i>
          API Backend
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Tab Navigation -->
    <div class="glass rounded-lg mb-6 overflow-hidden">
      <div class="flex border-b border-gray-200">
        <button onclick="switchTab('all-terms')" id="tab-all-terms" class="tab-btn flex-1 px-6 py-4 font-semibold text-gray-700 hover:bg-gray-50 border-b-2 border-indigo-600">
          <i class="fas fa-list mr-2"></i>All Terms
        </button>
        <button onclick="switchTab('term-lookup')" id="tab-term-lookup" class="tab-btn flex-1 px-6 py-4 font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent">
          <i class="fas fa-search mr-2"></i>Term Lookup
        </button>
        <button onclick="switchTab('logical-query')" id="tab-logical-query" class="tab-btn flex-1 px-6 py-4 font-semibold text-gray-500 hover:bg-gray-50 border-b-2 border-transparent">
          <i class="fas fa-flask mr-2"></i>Logical Query
        </button>
      </div>
    </div>

    <!-- Tab Content: All Terms -->
    <div id="content-all-terms" class="tab-content">
      <div class="glass rounded-lg p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-database text-indigo-600"></i>
          Browse All Available Terms
        </h2>
        <p class="text-gray-600 mb-4">View all terms available in the Neurosynth database.</p>
        <button onclick="fetchAllTerms()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 flex items-center gap-2">
          <i class="fas fa-sync-alt"></i>
          Load All Terms
        </button>
      </div>
      <div id="all-terms-result" class="glass rounded-lg p-6"></div>
    </div>

    <!-- Tab Content: Term Lookup -->
    <div id="content-term-lookup" class="tab-content hidden">
      <div class="glass rounded-lg p-6 mb-6 relative z-20">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-search text-indigo-600"></i>
          Look Up Associated Terms
        </h2>
        <p class="text-gray-600 mb-4">Find terms associated with a specific term.</p>
        <div class="flex gap-3 relative">
          <div class="flex-1 relative">
            <input 
              type="text" 
              id="term-input" 
              placeholder="Enter a term (e.g., amygdala)" 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
              onkeypress="if(event.key === 'Enter') fetchAssociatedTerms()"
              oninput="handleTermInputChange(event)"
              onblur="setTimeout(() => hideTermSuggestions(), 200)"
              onfocus="if(this.value.length >= 2) handleTermInputChange(event)"
              autocomplete="off"
            />
            <div id="term-suggestions" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
          </div>
          <button onclick="fetchAssociatedTerms()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 flex items-center gap-2">
            <i class="fas fa-search"></i>
            Search
          </button>
        </div>
        <div class="mt-3">
          <span class="text-sm text-gray-600">Examples:</span>
          <div class="flex flex-wrap gap-2 mt-2">
            <button onclick="setTermInput('amygdala')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-700">amygdala</button>
            <button onclick="setTermInput('emotion')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-700">emotion</button>
            <button onclick="setTermInput('memory')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-700">memory</button>
          </div>
        </div>
      </div>
      <div id="term-lookup-result" class="glass rounded-lg p-6 relative z-10"></div>
    </div>

    <!-- Tab Content: Logical Query -->
    <div id="content-logical-query" class="tab-content hidden">
      <div class="glass rounded-lg p-6 mb-6 relative z-20">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-flask text-indigo-600"></i>
          Logical Query Search
        </h2>
        <p class="text-gray-600 mb-4">Search for studies using logical operators (AND, OR, NOT).</p>
        <div class="flex gap-3 items-end">
          <div class="flex-1 relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Term 1</label>
            <input 
              type="text" 
              id="query-term1" 
              placeholder="e.g., amygdala" 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
              onkeypress="if(event.key === 'Enter') fetchStudies()"
              oninput="handleQueryTermInput(event, 'query-term1-suggestions')"
              onblur="setTimeout(() => hideQuerySuggestions('query-term1-suggestions'), 200)"
              onfocus="if(this.value.length >= 2) handleQueryTermInput(event, 'query-term1-suggestions')"
              autocomplete="off"
            />
            <div id="query-term1-suggestions" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
          </div>
          <div class="w-32">
            <label class="block text-sm font-medium text-gray-700 mb-1">Operator</label>
            <select 
              id="query-operator" 
              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none bg-white appearance-none bg-no-repeat bg-right pr-8"
              style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-position: right 0.5rem center; background-size: 1.5em 1.5em;"
            >
              <option value="and">AND</option>
              <option value="or">OR</option>
              <option value="not" selected>NOT</option>
            </select>
          </div>
          <div class="flex-1 relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Term 2</label>
            <input 
              type="text" 
              id="query-term2" 
              placeholder="e.g., emotion" 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
              onkeypress="if(event.key === 'Enter') fetchStudies()"
              oninput="handleQueryTermInput(event, 'query-term2-suggestions')"
              onblur="setTimeout(() => hideQuerySuggestions('query-term2-suggestions'), 200)"
              onfocus="if(this.value.length >= 2) handleQueryTermInput(event, 'query-term2-suggestions')"
              autocomplete="off"
            />
            <div id="query-term2-suggestions" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
          </div>
          <button onclick="fetchStudies()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 flex items-center gap-2">
            <i class="fas fa-search"></i>
            Search
          </button>
        </div>
        <div class="mt-3">
          <span class="text-sm text-gray-600">Examples:</span>
          <div class="flex flex-wrap gap-2 mt-2">
            <button onclick="setQueryExample('amygdala', 'not', 'emotion')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-700">amygdala NOT emotion</button>
            <button onclick="setQueryExample('memory', 'and', 'emotion')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-700">memory AND emotion</button>
            <button onclick="setQueryExample('pain', 'or', 'anxiety')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full text-gray-700">pain OR anxiety</button>
          </div>
        </div>
      </div>
      <div id="logical-query-result" class="glass rounded-lg p-6 relative z-10"></div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="glass border-t border-gray-200 mt-12">
    <div class="container mx-auto px-4 py-4 text-center text-gray-600">
      <p>Powered by <a href="https://mil.psy.ntu.edu.tw:5000" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">Neurosynth API</a></p>
    </div>
  </footer>

  <script>
    const API_BASE = 'https://mil.psy.ntu.edu.tw:5000';

    // Tab switching
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      // Remove active state from all tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-600', 'text-gray-700');
        btn.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Show selected tab content
      document.getElementById(`content-${tabName}`).classList.remove('hidden');
      
      // Add active state to selected tab
      const activeTab = document.getElementById(`tab-${tabName}`);
      activeTab.classList.add('border-indigo-600', 'text-gray-700');
      activeTab.classList.remove('border-transparent', 'text-gray-500');
    }

    // Helper functions for setting input values
    function setTermInput(value) {
      document.getElementById('term-input').value = value;
      hideTermSuggestions();
      fetchAssociatedTerms();
    }

    function setQueryExample(term1, operator, term2) {
      document.getElementById('query-term1').value = term1;
      document.getElementById('query-operator').value = operator;
      document.getElementById('query-term2').value = term2;
      fetchStudies();
    }

    // Term autocomplete functionality
    let allTermsCache = null;
    let termInputTimeout = null;

    async function loadTermsForAutocomplete() {
      if (allTermsCache) return allTermsCache;
      
      try {
        const response = await fetch(`${API_BASE}/terms`);
        if (!response.ok) return [];
        
        const data = await response.json();
        if (data.terms && Array.isArray(data.terms)) {
          allTermsCache = data.terms;
        } else if (typeof data === 'object') {
          allTermsCache = Object.keys(data);
        } else {
          allTermsCache = [];
        }
        return allTermsCache;
      } catch (error) {
        console.error('Failed to load terms for autocomplete:', error);
        return [];
      }
    }

    function handleTermInputChange(event) {
      const input = event.target.value.trim();
      
      // Clear previous timeout
      if (termInputTimeout) {
        clearTimeout(termInputTimeout);
      }
      
      if (input.length < 2) {
        hideTermSuggestions();
        return;
      }
      
      // Debounce the search
      termInputTimeout = setTimeout(async () => {
        await showTermSuggestions(input);
      }, 300);
    }

    async function showTermSuggestions(query) {
      const terms = await loadTermsForAutocomplete();
      const suggestionsDiv = document.getElementById('term-suggestions');
      
      if (terms.length === 0) {
        hideTermSuggestions();
        return;
      }
      
      // Filter matching terms (case-insensitive)
      const queryLower = query.toLowerCase();
      const matches = terms
        .filter(term => term.toLowerCase().includes(queryLower))
        .slice(0, 10); // Limit to 10 suggestions
      
      if (matches.length === 0) {
        hideTermSuggestions();
        return;
      }
      
      // Display suggestions
      suggestionsDiv.innerHTML = matches.map(term => `
        <div 
          class="px-4 py-2 hover:bg-indigo-50 cursor-pointer text-gray-800 border-b border-gray-100 last:border-b-0"
          onmousedown="setTermInput('${term}')"
        >
          ${highlightMatch(term, query)}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }

    function hideTermSuggestions() {
      const suggestionsDiv = document.getElementById('term-suggestions');
      suggestionsDiv.classList.add('hidden');
    }

    function highlightMatch(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<span class="font-semibold text-indigo-600">$1</span>');
    }

    // Query term autocomplete functionality
    let queryTermTimeout = null;

    function handleQueryTermInput(event, suggestionsDivId) {
      const input = event.target.value.trim();
      
      // Clear previous timeout
      if (queryTermTimeout) {
        clearTimeout(queryTermTimeout);
      }
      
      if (input.length < 2) {
        hideQuerySuggestions(suggestionsDivId);
        return;
      }
      
      // Debounce the search
      queryTermTimeout = setTimeout(async () => {
        await showQueryTermSuggestions(input, suggestionsDivId, event.target.id);
      }, 300);
    }

    async function showQueryTermSuggestions(query, suggestionsDivId, inputId) {
      const terms = await loadTermsForAutocomplete();
      const suggestionsDiv = document.getElementById(suggestionsDivId);
      
      if (terms.length === 0) {
        hideQuerySuggestions(suggestionsDivId);
        return;
      }
      
      // Filter matching terms (case-insensitive)
      const queryLower = query.toLowerCase();
      const matches = terms
        .filter(term => term.toLowerCase().includes(queryLower))
        .slice(0, 10); // Limit to 10 suggestions
      
      if (matches.length === 0) {
        hideQuerySuggestions(suggestionsDivId);
        return;
      }
      
      // Display suggestions
      suggestionsDiv.innerHTML = matches.map(term => `
        <div 
          class="px-4 py-2 hover:bg-indigo-50 cursor-pointer text-gray-800 border-b border-gray-100 last:border-b-0"
          onmousedown="setQueryTermValue('${inputId}', '${term}', '${suggestionsDivId}')"
        >
          ${highlightMatch(term, query)}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }

    function setQueryTermValue(inputId, value, suggestionsDivId) {
      document.getElementById(inputId).value = value;
      hideQuerySuggestions(suggestionsDivId);
    }

    function hideQuerySuggestions(suggestionsDivId) {
      const suggestionsDiv = document.getElementById(suggestionsDivId);
      if (suggestionsDiv) {
        suggestionsDiv.classList.add('hidden');
      }
    }

    // Loading state
    function showLoading(elementId) {
      const element = document.getElementById(elementId);
      element.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12">
          <div class="loading-spinner"></div>
          <p class="text-gray-600 mt-4">Loading...</p>
        </div>
      `;
    }

    // Error display
    function showError(elementId, message, details = '') {
      const element = document.getElementById(elementId);
      element.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 fade-in">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-circle text-red-500 text-xl mt-1"></i>
            <div class="flex-1">
              <h3 class="text-red-800 font-semibold text-lg mb-2">Error</h3>
              <p class="text-red-700">${message}</p>
              ${details ? `<pre class="mt-3 text-sm text-red-600 bg-red-100 p-3 rounded overflow-auto">${details}</pre>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // Fetch all terms
    async function fetchAllTerms() {
      showLoading('all-terms-result');
      
      try {
        const response = await fetch(`${API_BASE}/terms`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        displayAllTerms(data);
        
      } catch (error) {
        showError('all-terms-result', 'Failed to fetch terms', error.message);
      }
    }

    function displayAllTerms(data) {
      const element = document.getElementById('all-terms-result');
      
      // Handle both formats: array {"terms": [...]} or object {"term": count, ...}
      let terms = [];
      
      if (data.terms && Array.isArray(data.terms)) {
        // Format: {"terms": ["term1", "term2", ...]}
        terms = data.terms;
      } else if (typeof data === 'object' && !Array.isArray(data)) {
        // Format: {"term1": count1, "term2": count2, ...}
        terms = Object.keys(data);
      } else {
        element.innerHTML = '<p class="text-gray-600">No terms found.</p>';
        return;
      }
      
      if (terms.length === 0) {
        element.innerHTML = '<p class="text-gray-600">No terms found.</p>';
        return;
      }
      
      // Sort terms alphabetically
      terms.sort();
      
      element.innerHTML = `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-list-ul text-indigo-600 mr-2"></i>
              Found ${terms.length} Terms
            </h3>
            <input 
              type="text" 
              id="term-filter" 
              placeholder="Filter terms..." 
              onkeyup="filterTerms()"
              class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
            />
          </div>
          
          <!-- Alphabet Jump Navigation -->
          <div class="mb-4 p-3 bg-white border border-gray-200 rounded-lg">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-sm font-medium text-gray-600 mr-2">Jump to:</span>
              ${['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'].map(letter => `
                <button 
                  onclick="jumpToLetter('${letter}')" 
                  class="alphabet-btn w-8 h-8 text-sm font-semibold rounded hover:bg-indigo-600 hover:text-white transition-colors ${terms.some(t => t.toLowerCase().startsWith(letter.toLowerCase())) ? 'bg-indigo-100 text-indigo-700 cursor-pointer' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}"
                  ${!terms.some(t => t.toLowerCase().startsWith(letter.toLowerCase())) ? 'disabled' : ''}
                >
                  ${letter}
                </button>
              `).join('')}
              <button 
                onclick="jumpToLetter('0-9')" 
                class="alphabet-btn px-3 h-8 text-sm font-semibold rounded hover:bg-indigo-600 hover:text-white transition-colors ${terms.some(t => /^[0-9]/.test(t)) ? 'bg-indigo-100 text-indigo-700 cursor-pointer' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}"
                ${!terms.some(t => /^[0-9]/.test(t)) ? 'disabled' : ''}
              >
                0-9
              </button>
            </div>
          </div>
          
          <div id="terms-grid" class="space-y-2 max-h-[600px] overflow-y-auto">
            ${terms.map((term) => `
              <div class="result-card bg-white border border-gray-200 rounded-lg px-4 py-3 cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all" data-term="${term}" onclick="setTermInput('${term}'); switchTab('term-lookup')">
                <span class="font-medium text-gray-800">${term}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function filterTerms() {
      const filter = document.getElementById('term-filter').value.toLowerCase();
      const cards = document.querySelectorAll('#terms-grid > div');
      
      cards.forEach(card => {
        const term = card.textContent.toLowerCase();
        card.style.display = term.includes(filter) ? '' : 'none';
      });
    }

    function jumpToLetter(letter) {
      const cards = document.querySelectorAll('#terms-grid > div');
      const container = document.getElementById('terms-grid');
      
      if (!container) return;
      
      // Clear any filter
      const filterInput = document.getElementById('term-filter');
      if (filterInput) filterInput.value = '';
      
      // Show all cards first
      cards.forEach(card => {
        card.style.display = '';
      });
      
      // Find first term starting with the letter
      let targetCard = null;
      
      if (letter === '0-9') {
        targetCard = Array.from(cards).find(card => {
          const term = card.getAttribute('data-term');
          return term && /^[0-9]/.test(term);
        });
      } else {
        targetCard = Array.from(cards).find(card => {
          const term = card.getAttribute('data-term');
          return term && term.toLowerCase().startsWith(letter.toLowerCase());
        });
      }
      
      // Scroll to the target card
      if (targetCard) {
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Highlight the target briefly
        targetCard.classList.add('ring-2', 'ring-indigo-500');
        setTimeout(() => {
          targetCard.classList.remove('ring-2', 'ring-indigo-500');
        }, 1500);
      }
    }

    // Fetch associated terms
    async function fetchAssociatedTerms() {
      const term = document.getElementById('term-input').value.trim();
      
      if (!term) {
        showError('term-lookup-result', 'Please enter a term to search.');
        return;
      }
      
      showLoading('term-lookup-result');
      
      try {
        const response = await fetch(`${API_BASE}/terms/${encodeURIComponent(term)}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        displayAssociatedTerms(term, data);
        
      } catch (error) {
        showError('term-lookup-result', `Failed to fetch associated terms for "${term}"`, error.message);
      }
    }

    function displayAssociatedTerms(searchTerm, data) {
      const element = document.getElementById('term-lookup-result');
      
      // Handle the new format: {"related": [...], "term": "..."}
      let relatedTerms = [];
      
      if (data && data.related && Array.isArray(data.related)) {
        relatedTerms = data.related;
      } else if (data && typeof data === 'object' && !Array.isArray(data)) {
        // Fallback: old format {"term1": score1, ...}
        relatedTerms = Object.entries(data).map(([term, score]) => ({
          term: term,
          jaccard: score,
          co_count: 0
        }));
      }
      
      if (relatedTerms.length === 0) {
        element.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-600">No associated terms found for "${searchTerm}".</p>
          </div>
        `;
        return;
      }
      
      // Sort by jaccard coefficient (descending)
      relatedTerms.sort((a, b) => b.jaccard - a.jaccard);
      
      element.innerHTML = `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-link text-indigo-600 mr-2"></i>
              Terms Associated with "${searchTerm}"
            </h3>
            <span class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-semibold">
              ${relatedTerms.length} ${relatedTerms.length === 1 ? 'term' : 'terms'}
            </span>
          </div>
          <div class="space-y-3 max-h-[600px] overflow-y-auto">
            ${relatedTerms.map((item, index) => `
              <div class="result-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer" onclick="setTermInput('${item.term}')">
                <div class="flex items-center justify-between gap-4">
                  <div class="flex items-center gap-3 flex-1 min-w-0">
                    <span class="text-indigo-600 font-bold text-lg flex-shrink-0">#${index + 1}</span>
                    <span class="font-semibold text-gray-800 text-lg truncate">${item.term}</span>
                  </div>
                  <div class="flex items-center gap-6 flex-shrink-0">
                    <div class="text-right">
                      <div class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Jaccard</div>
                      <div class="text-base font-bold text-indigo-600">${Number(item.jaccard).toFixed(4)}</div>
                    </div>
                    <div class="text-right">
                      <div class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Co-occur</div>
                      <div class="text-base font-bold text-gray-700">${item.co_count}</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Fetch studies
    async function fetchStudies() {
      const term1 = document.getElementById('query-term1').value.trim();
      const operator = document.getElementById('query-operator').value;
      const term2 = document.getElementById('query-term2').value.trim();
      
      if (!term1 || !term2) {
        showError('logical-query-result', 'Please enter both terms to search.');
        return;
      }
      
      // Build the query string: "term1 operator term2"
      const query = `${term1} ${operator} ${term2}`;
      
      showLoading('logical-query-result');
      
      try {
        const response = await fetch(`${API_BASE}/query/${encodeURIComponent(query)}/studies`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        displayStudies(query, data);
        
      } catch (error) {
        showError('logical-query-result', `Failed to fetch studies for query "${query}"`, error.message);
      }
    }

    function displayStudies(query, data) {
      const element = document.getElementById('logical-query-result');
      
      // Handle the format: {"count": N, "results": [...], "applied": {...}}
      let studies = [];
      let totalCount = 0;
      
      if (data && data.results && Array.isArray(data.results)) {
        studies = data.results;
        totalCount = data.count || studies.length;
      } else if (data && Array.isArray(data)) {
        // Fallback: if data is directly an array
        studies = data;
        totalCount = studies.length;
      }
      
      if (studies.length === 0) {
        element.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-file-alt text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-600">No studies found for query "${query}".</p>
          </div>
        `;
        return;
      }
      
      // Store original studies for filtering
      window.currentStudies = studies;
      window.currentQuery = query;
      window.currentTotalCount = totalCount;
      
      // Get year range
      const years = studies.map(s => s.year).filter(y => y);
      const minYear = years.length > 0 ? Math.min(...years) : new Date().getFullYear();
      const maxYear = years.length > 0 ? Math.max(...years) : new Date().getFullYear();
      
      element.innerHTML = `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-file-medical text-indigo-600 mr-2"></i>
              Studies Matching "${query}"
            </h3>
            <span class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-semibold">
              <span id="filtered-count">${totalCount}</span> ${totalCount === 1 ? 'study' : 'studies'}
            </span>
          </div>
          
          <!-- Advanced Filters -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold text-gray-700 flex items-center gap-2">
                <i class="fas fa-filter text-indigo-600"></i>
                Advanced Filters
              </h4>
              <button onclick="resetStudyFilters()" class="text-sm text-indigo-600 hover:text-indigo-800 underline">
                <i class="fas fa-redo-alt mr-1"></i>Reset
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <!-- Sort By -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-sort mr-1"></i>Sort By
                </label>
                <select id="study-sort" onchange="applyStudyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm bg-white appearance-none bg-no-repeat bg-right pr-8" style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27currentColor%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-position: right 0.5rem center; background-size: 1.5em 1.5em;">
                  <option value="default">Default Order</option>
                  <option value="year-desc">Year (Newest First)</option>
                  <option value="year-asc">Year (Oldest First)</option>
                  <option value="title-asc">Title (A-Z)</option>
                  <option value="title-desc">Title (Z-A)</option>
                  <option value="author-asc">Author (A-Z)</option>
                  <option value="author-desc">Author (Z-A)</option>
                </select>
              </div>
              
              <!-- Author Search -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-user mr-1"></i>Author
                </label>
                <input 
                  type="text" 
                  id="author-filter" 
                  placeholder="Filter by author..." 
                  oninput="applyStudyFilters()"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm"
                />
              </div>
              
              <!-- Journal Search -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-book mr-1"></i>Journal
                </label>
                <input 
                  type="text" 
                  id="journal-filter" 
                  placeholder="Filter by journal..." 
                  oninput="applyStudyFilters()"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm"
                />
              </div>
              
              <!-- Year Range -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  <i class="fas fa-calendar mr-1"></i>Year Range
                </label>
                <div class="flex gap-2">
                  <input 
                    type="number" 
                    id="year-from" 
                    placeholder="From" 
                    min="${minYear}" 
                    max="${maxYear}" 
                    value="${minYear}"
                    oninput="applyStudyFilters()"
                    class="w-1/2 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm"
                  />
                  <input 
                    type="number" 
                    id="year-to" 
                    placeholder="To" 
                    min="${minYear}" 
                    max="${maxYear}" 
                    value="${maxYear}"
                    oninput="applyStudyFilters()"
                    class="w-1/2 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm"
                  />
                </div>
              </div>
            </div>
          </div>
          
          <div id="studies-container" class="space-y-4 max-h-[600px] overflow-y-auto">
            ${renderStudiesList(studies)}
          </div>
        </div>
      `;
    }

    function renderStudiesList(studies) {
      if (studies.length === 0) {
        return `
          <div class="text-center py-8">
            <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-600">No studies match the current filters.</p>
          </div>
        `;
      }
      
      return studies.map((study, index) => {
        const pubmedUrl = study.study_id ? `https://pubmed.ncbi.nlm.nih.gov/${study.study_id}/` : null;
        return `
        <div class="result-card bg-white border border-gray-200 rounded-lg p-5 ${pubmedUrl ? 'cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all' : ''}" ${pubmedUrl ? `onclick="window.open('${pubmedUrl}', '_blank')"` : ''}>
          <div class="flex items-start gap-3">
            <span class="text-indigo-600 font-bold text-lg flex-shrink-0">#${index + 1}</span>
            <div class="flex-1">
              <h4 class="font-semibold text-gray-800 mb-2">
                ${study.title || 'Untitled Study'}
              </h4>
              <div class="space-y-1">
                ${study.authors ? `<p class="text-sm text-gray-600"><i class="fas fa-user mr-2 w-4 inline-block text-center"></i>${study.authors}</p>` : ''}
                ${study.journal ? `<p class="text-sm text-gray-600"><i class="fas fa-book mr-2 w-4 inline-block text-center"></i>${study.journal}</p>` : ''}
                ${study.year ? `<p class="text-sm text-gray-600"><i class="fas fa-calendar mr-2 w-4 inline-block text-center"></i>${study.year}</p>` : ''}
                ${study.study_id ? `<p class="text-sm text-gray-600"><i class="fas fa-hashtag mr-2 w-4 inline-block text-center"></i>${study.study_id}</p>` : ''}
              </div>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }

    function applyStudyFilters() {
      if (!window.currentStudies) return;
      
      let filteredStudies = [...window.currentStudies];
      
      // Apply author filter
      const authorFilter = document.getElementById('author-filter')?.value.toLowerCase().trim();
      if (authorFilter) {
        filteredStudies = filteredStudies.filter(study => 
          study.authors && study.authors.toLowerCase().includes(authorFilter)
        );
      }
      
      // Apply journal filter
      const journalFilter = document.getElementById('journal-filter')?.value.toLowerCase().trim();
      if (journalFilter) {
        filteredStudies = filteredStudies.filter(study => 
          study.journal && study.journal.toLowerCase().includes(journalFilter)
        );
      }
      
      // Apply year range filter
      const yearFrom = parseInt(document.getElementById('year-from')?.value);
      const yearTo = parseInt(document.getElementById('year-to')?.value);
      if (!isNaN(yearFrom) && !isNaN(yearTo)) {
        filteredStudies = filteredStudies.filter(study => 
          study.year && study.year >= yearFrom && study.year <= yearTo
        );
      }
      
      // Apply sorting
      const sortBy = document.getElementById('study-sort')?.value;
      switch(sortBy) {
        case 'year-desc':
          filteredStudies.sort((a, b) => (b.year || 0) - (a.year || 0));
          break;
        case 'year-asc':
          filteredStudies.sort((a, b) => (a.year || 0) - (b.year || 0));
          break;
        case 'title-asc':
          filteredStudies.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
          break;
        case 'title-desc':
          filteredStudies.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
          break;
        case 'author-asc':
          filteredStudies.sort((a, b) => (a.authors || '').localeCompare(b.authors || ''));
          break;
        case 'author-desc':
          filteredStudies.sort((a, b) => (b.authors || '').localeCompare(a.authors || ''));
          break;
      }
      
      // Update display
      const container = document.getElementById('studies-container');
      if (container) {
        container.innerHTML = renderStudiesList(filteredStudies);
      }
      
      // Update count
      const countElement = document.getElementById('filtered-count');
      if (countElement) {
        countElement.textContent = filteredStudies.length;
      }
    }

    function resetStudyFilters() {
      // Reset all filter inputs
      const sortSelect = document.getElementById('study-sort');
      const authorInput = document.getElementById('author-filter');
      const journalInput = document.getElementById('journal-filter');
      const yearFrom = document.getElementById('year-from');
      const yearTo = document.getElementById('year-to');
      
      if (sortSelect) sortSelect.value = 'default';
      if (authorInput) authorInput.value = '';
      if (journalInput) journalInput.value = '';
      
      // Reset year range to original values
      if (window.currentStudies) {
        const years = window.currentStudies.map(s => s.year).filter(y => y);
        const minYear = years.length > 0 ? Math.min(...years) : new Date().getFullYear();
        const maxYear = years.length > 0 ? Math.max(...years) : new Date().getFullYear();
        
        if (yearFrom) yearFrom.value = minYear;
        if (yearTo) yearTo.value = maxYear;
      }
      
      // Reapply filters (which will show all studies)
      applyStudyFilters();
    }

    // Initialize: Load all terms on page load
    window.addEventListener('DOMContentLoaded', () => {
      fetchAllTerms();
    });
  </script>
</body>
</html>

